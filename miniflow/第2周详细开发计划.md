# MiniFlow 第2周详细开发计划

## 📋 周目标概览

**开发周期**: 第2周 (5天 × 8小时 = 40小时)  
**主要目标**: 实现可视化流程建模器和流程定义管理功能  
**技术重点**: ReactFlow集成、流程数据模型、可视化编辑器  
**交付成果**: 完整的流程设计和管理系统

---

## 📅 每日开发计划

### Day 6 (Monday) - 8小时
**主题**: 流程数据模型设计和后端API

#### 上午 (4小时)
**9:00-11:00 流程数据模型设计 (2小时)**

创建 `internal/model/process.go`:
```go
// ProcessDefinition 流程定义模型
type ProcessDefinition struct {
    BaseModel
    Key            string    `gorm:"type:varchar(100);not null;uniqueIndex" json:"key"`
    Name           string    `gorm:"type:varchar(255);not null;index" json:"name"`
    Version        int       `gorm:"not null;default:1" json:"version"`
    Description    string    `gorm:"type:text" json:"description"`
    Category       string    `gorm:"type:varchar(50);index" json:"category"`
    DefinitionJSON string    `gorm:"type:json;not null" json:"definition_json"`
    Status         string    `gorm:"type:varchar(20);not null;default:draft;index" json:"status"`
    CreatedBy      uint      `gorm:"not null;index" json:"created_by"`
    
    // 关联关系
    Creator   User              `gorm:"foreignKey:CreatedBy" json:"creator,omitempty"`
    Instances []ProcessInstance `gorm:"foreignKey:DefinitionID" json:"instances,omitempty"`
}

// ProcessNode 流程节点
type ProcessNode struct {
    ID       string            `json:"id"`
    Type     string            `json:"type"` // start, end, userTask, serviceTask, gateway
    Name     string            `json:"name"`
    X        float64           `json:"x"`
    Y        float64           `json:"y"`
    Props    map[string]interface{} `json:"props,omitempty"`
}

// ProcessFlow 流程连线
type ProcessFlow struct {
    ID        string `json:"id"`
    From      string `json:"from"`
    To        string `json:"to"`
    Condition string `json:"condition,omitempty"`
    Label     string `json:"label,omitempty"`
}

// ProcessDefinitionData 流程定义数据结构
type ProcessDefinitionData struct {
    Nodes []ProcessNode `json:"nodes"`
    Flows []ProcessFlow `json:"flows"`
}
```

**11:00-13:00 流程Repository层 (2小时)**

创建 `internal/repository/process.go`:
```go
type ProcessRepository struct {
    db     *database.Database
    logger *logger.Logger
}

func NewProcessRepository(db *database.Database, logger *logger.Logger) *ProcessRepository {
    return &ProcessRepository{db: db, logger: logger}
}

// CRUD操作
func (r *ProcessRepository) Create(process *model.ProcessDefinition) error
func (r *ProcessRepository) GetByID(id uint) (*model.ProcessDefinition, error)
func (r *ProcessRepository) GetByKey(key string) (*model.ProcessDefinition, error)
func (r *ProcessRepository) Update(process *model.ProcessDefinition) error
func (r *ProcessRepository) Delete(id uint) error
func (r *ProcessRepository) List(offset, limit int, filters map[string]interface{}) ([]*model.ProcessDefinition, int64, error)

// 版本管理
func (r *ProcessRepository) GetLatestVersion(key string) (*model.ProcessDefinition, error)
func (r *ProcessRepository) GetVersions(key string) ([]*model.ProcessDefinition, error)
func (r *ProcessRepository) CreateVersion(process *model.ProcessDefinition) error

// 分类和搜索
func (r *ProcessRepository) GetByCategory(category string) ([]*model.ProcessDefinition, error)
func (r *ProcessRepository) Search(keyword string) ([]*model.ProcessDefinition, error)
```

#### 下午 (4小时)
**14:00-16:00 流程Service层 (2小时)**

创建 `internal/service/process.go`:
```go
type ProcessService struct {
    processRepo *repository.ProcessRepository
    userRepo    *repository.UserRepository
    logger      *logger.Logger
}

// 请求响应结构
type CreateProcessRequest struct {
    Key         string                    `json:"key" validate:"required,min=3,max=100"`
    Name        string                    `json:"name" validate:"required,min=1,max=255"`
    Description string                    `json:"description"`
    Category    string                    `json:"category"`
    Definition  model.ProcessDefinitionData `json:"definition"`
}

type UpdateProcessRequest struct {
    Name        string                    `json:"name" validate:"required,min=1,max=255"`
    Description string                    `json:"description"`
    Category    string                    `json:"category"`
    Definition  model.ProcessDefinitionData `json:"definition"`
}

// 业务逻辑方法
func (s *ProcessService) CreateProcess(userID uint, req *CreateProcessRequest) (*model.ProcessDefinition, error)
func (s *ProcessService) UpdateProcess(processID uint, userID uint, req *UpdateProcessRequest) (*model.ProcessDefinition, error)
func (s *ProcessService) GetProcess(processID uint) (*model.ProcessDefinition, error)
func (s *ProcessService) DeleteProcess(processID uint, userID uint) error
func (s *ProcessService) GetUserProcesses(userID uint, page, pageSize int) ([]*model.ProcessDefinition, int64, error)
func (s *ProcessService) ValidateProcessDefinition(definition *model.ProcessDefinitionData) error
```

**16:00-18:00 流程Handler层 (2小时)**

创建 `internal/handler/process.go`:
```go
type ProcessHandler struct {
    processService *service.ProcessService
    logger         *logger.Logger
    validator      *utils.CustomValidator
}

// API处理方法
func (h *ProcessHandler) CreateProcess(c echo.Context) error
func (h *ProcessHandler) GetProcess(c echo.Context) error
func (h *ProcessHandler) UpdateProcess(c echo.Context) error
func (h *ProcessHandler) DeleteProcess(c echo.Context) error
func (h *ProcessHandler) GetProcesses(c echo.Context) error
func (h *ProcessHandler) GetProcessVersions(c echo.Context) error
```

#### 📝 Day 6 交付清单
- [ ] 流程数据模型完成
- [ ] 流程Repository层实现
- [ ] 流程Service层业务逻辑
- [ ] 流程Handler层API接口
- [ ] 数据库迁移和索引

---

### Day 7 (Tuesday) - 8小时
**主题**: ReactFlow集成和基础流程建模器

#### 上午 (4小时)
**9:00-11:00 ReactFlow基础集成 (2小时)**

安装依赖和基础配置:
```bash
cd frontend
npm install reactflow @reactflow/core @reactflow/background @reactflow/controls @reactflow/minimap
```

创建 `src/types/process.ts`:
```typescript
export interface ProcessNode {
  id: string;
  type: 'start' | 'end' | 'userTask' | 'serviceTask' | 'gateway';
  position: { x: number; y: number };
  data: {
    label: string;
    assignee?: string;
    condition?: string;
    [key: string]: any;
  };
}

export interface ProcessEdge {
  id: string;
  source: string;
  target: string;
  label?: string;
  type?: string;
  data?: {
    condition?: string;
  };
}

export interface ProcessDefinition {
  id?: number;
  key: string;
  name: string;
  description?: string;
  category?: string;
  version: number;
  status: 'draft' | 'published' | 'archived';
  definition: {
    nodes: ProcessNode[];
    edges: ProcessEdge[];
  };
  created_by: number;
  created_at: string;
  updated_at: string;
}
```

**11:00-13:00 自定义节点组件 (2小时)**

创建 `src/components/process/nodes/StartNode.tsx`:
```tsx
import React from 'react';
import { Handle, Position, NodeProps } from 'reactflow';

const StartNode: React.FC<NodeProps> = ({ data, selected }) => {
  return (
    <div className={`custom-node start-node ${selected ? 'selected' : ''}`}>
      <div className="node-header">
        <span className="node-icon">⭕</span>
        <span className="node-label">开始</span>
      </div>
      <Handle type="source" position={Position.Right} />
    </div>
  );
};

export default StartNode;
```

类似地创建 `EndNode.tsx`, `UserTaskNode.tsx`, `GatewayNode.tsx`

#### 下午 (4小时)
**14:00-16:00 流程设计器主组件 (2小时)**

创建 `src/components/process/ProcessDesigner.tsx`:
```tsx
import React, { useCallback, useState } from 'react';
import ReactFlow, {
  addEdge,
  Background,
  Controls,
  MiniMap,
  useNodesState,
  useEdgesState,
  Connection,
  Edge,
  NodeTypes,
} from 'reactflow';
import 'reactflow/dist/style.css';

import StartNode from './nodes/StartNode';
import EndNode from './nodes/EndNode';
import UserTaskNode from './nodes/UserTaskNode';
import GatewayNode from './nodes/GatewayNode';

const nodeTypes: NodeTypes = {
  start: StartNode,
  end: EndNode,
  userTask: UserTaskNode,
  gateway: GatewayNode,
};

const ProcessDesigner: React.FC = () => {
  const [nodes, setNodes, onNodesChange] = useNodesState([]);
  const [edges, setEdges, onEdgesChange] = useEdgesState([]);

  const onConnect = useCallback(
    (params: Connection) => {
      const edge: Edge = {
        ...params,
        id: `edge-${params.source}-${params.target}`,
        type: 'smoothstep',
        animated: true,
      };
      setEdges((eds) => addEdge(edge, eds));
    },
    [setEdges]
  );

  return (
    <div className="process-designer">
      <ReactFlow
        nodes={nodes}
        edges={edges}
        onNodesChange={onNodesChange}
        onEdgesChange={onEdgesChange}
        onConnect={onConnect}
        nodeTypes={nodeTypes}
        fitView
      >
        <Background variant="dots" gap={20} size={1} />
        <Controls />
        <MiniMap />
      </ReactFlow>
    </div>
  );
};

export default ProcessDesigner;
```

**16:00-18:00 节点工具栏 (2小时)**

创建 `src/components/process/NodePalette.tsx`:
```tsx
import React from 'react';
import { Card, Space, Button } from 'antd';
import { 
  PlayCircleOutlined, 
  StopOutlined, 
  UserOutlined, 
  BranchesOutlined 
} from '@ant-design/icons';

interface NodePaletteProps {
  onAddNode: (type: string) => void;
}

const NodePalette: React.FC<NodePaletteProps> = ({ onAddNode }) => {
  const nodeTypes = [
    { type: 'start', label: '开始', icon: <PlayCircleOutlined />, color: '#52c41a' },
    { type: 'userTask', label: '用户任务', icon: <UserOutlined />, color: '#1890ff' },
    { type: 'gateway', label: '条件网关', icon: <BranchesOutlined />, color: '#fa8c16' },
    { type: 'end', label: '结束', icon: <StopOutlined />, color: '#f5222d' },
  ];

  return (
    <Card title="节点工具箱" size="small" className="node-palette">
      <Space direction="vertical" style={{ width: '100%' }}>
        {nodeTypes.map(nodeType => (
          <Button
            key={nodeType.type}
            block
            icon={nodeType.icon}
            style={{ 
              borderColor: nodeType.color,
              color: nodeType.color 
            }}
            onClick={() => onAddNode(nodeType.type)}
          >
            {nodeType.label}
          </Button>
        ))}
      </Space>
    </Card>
  );
};

export default NodePalette;
```

#### 📝 Day 7 交付清单
- [ ] ReactFlow基础集成完成
- [ ] 自定义节点组件实现
- [ ] 流程设计器主组件
- [ ] 节点工具栏功能

---

### Day 8 (Wednesday) - 8小时
**主题**: 流程建模功能和数据转换

#### 上午 (4小时)
**9:00-11:00 连线和画布操作 (2小时)**

增强 ProcessDesigner 功能:
```tsx
// 添加到 ProcessDesigner.tsx
const [selectedNode, setSelectedNode] = useState<string | null>(null);
const [selectedEdge, setSelectedEdge] = useState<string | null>(null);

// 节点拖拽结束处理
const onNodeDragStop = useCallback((event: MouseEvent, node: Node) => {
  // 保存节点位置
  console.log('Node moved:', node.id, node.position);
}, []);

// 节点选择处理
const onNodeClick = useCallback((event: MouseEvent, node: Node) => {
  setSelectedNode(node.id);
  setSelectedEdge(null);
}, []);

// 连线选择处理
const onEdgeClick = useCallback((event: MouseEvent, edge: Edge) => {
  setSelectedEdge(edge.id);
  setSelectedNode(null);
}, []);

// 删除选中元素
const onDeleteSelected = useCallback(() => {
  if (selectedNode) {
    setNodes(nds => nds.filter(n => n.id !== selectedNode));
    setSelectedNode(null);
  }
  if (selectedEdge) {
    setEdges(eds => eds.filter(e => e.id !== selectedEdge));
    setSelectedEdge(null);
  }
}, [selectedNode, selectedEdge, setNodes, setEdges]);
```

**11:00-13:00 节点属性编辑面板 (2小时)**

创建 `src/components/process/NodePropertiesPanel.tsx`:
```tsx
import React from 'react';
import { Card, Form, Input, Select, Button, Space } from 'antd';
import { DeleteOutlined, EditOutlined } from '@ant-design/icons';

interface NodePropertiesPanelProps {
  selectedNode: any;
  onUpdateNode: (nodeId: string, updates: any) => void;
  onDeleteNode: (nodeId: string) => void;
}

const NodePropertiesPanel: React.FC<NodePropertiesPanelProps> = ({
  selectedNode,
  onUpdateNode,
  onDeleteNode
}) => {
  const [form] = Form.useForm();

  if (!selectedNode) {
    return (
      <Card title="属性面板" size="small">
        <p>请选择一个节点来编辑属性</p>
      </Card>
    );
  }

  const handleSave = (values: any) => {
    onUpdateNode(selectedNode.id, values);
  };

  return (
    <Card 
      title="节点属性" 
      size="small"
      extra={
        <Space>
          <Button 
            type="text" 
            icon={<EditOutlined />} 
            size="small"
          />
          <Button 
            type="text" 
            danger 
            icon={<DeleteOutlined />} 
            size="small"
            onClick={() => onDeleteNode(selectedNode.id)}
          />
        </Space>
      }
    >
      <Form
        form={form}
        layout="vertical"
        initialValues={selectedNode.data}
        onFinish={handleSave}
        size="small"
      >
        <Form.Item name="label" label="节点名称">
          <Input placeholder="输入节点名称" />
        </Form.Item>
        
        {selectedNode.type === 'userTask' && (
          <Form.Item name="assignee" label="处理人">
            <Select placeholder="选择处理人">
              <Select.Option value="admin">管理员</Select.Option>
              <Select.Option value="user">普通用户</Select.Option>
            </Select>
          </Form.Item>
        )}
        
        {selectedNode.type === 'gateway' && (
          <Form.Item name="condition" label="条件表达式">
            <Input.TextArea 
              placeholder="输入条件表达式，如: approved == true"
              rows={3}
            />
          </Form.Item>
        )}
        
        <Form.Item>
          <Button type="primary" htmlType="submit" size="small" block>
            保存更改
          </Button>
        </Form.Item>
      </Form>
    </Card>
  );
};

export default NodePropertiesPanel;
```

#### 下午 (4小时)
**14:00-16:00 数据转换功能 (2小时)**

创建 `src/utils/processConverter.ts`:
```typescript
import { Node, Edge } from 'reactflow';
import { ProcessDefinition, ProcessNode, ProcessFlow } from '../types/process';

export class ProcessConverter {
  // ReactFlow格式转换为内部格式
  static reactFlowToInternal(nodes: Node[], edges: Edge[]): {
    nodes: ProcessNode[];
    flows: ProcessFlow[];
  } {
    const processNodes: ProcessNode[] = nodes.map(node => ({
      id: node.id,
      type: node.type || 'userTask',
      name: node.data.label || '',
      x: node.position.x,
      y: node.position.y,
      props: {
        assignee: node.data.assignee,
        condition: node.data.condition,
        ...node.data
      }
    }));

    const processFlows: ProcessFlow[] = edges.map(edge => ({
      id: edge.id,
      from: edge.source,
      to: edge.target,
      condition: edge.data?.condition || '',
      label: edge.label as string || ''
    }));

    return { nodes: processNodes, flows: processFlows };
  }

  // 内部格式转换为ReactFlow格式
  static internalToReactFlow(definition: ProcessDefinitionData): {
    nodes: Node[];
    edges: Edge[];
  } {
    const reactNodes: Node[] = definition.nodes.map(node => ({
      id: node.id,
      type: node.type,
      position: { x: node.x, y: node.y },
      data: {
        label: node.name,
        assignee: node.props?.assignee,
        condition: node.props?.condition,
        ...node.props
      }
    }));

    const reactEdges: Edge[] = definition.flows.map(flow => ({
      id: flow.id,
      source: flow.from,
      target: flow.to,
      label: flow.label,
      type: 'smoothstep',
      animated: true,
      data: {
        condition: flow.condition
      }
    }));

    return { nodes: reactNodes, edges: reactEdges };
  }

  // 验证流程定义
  static validateProcess(nodes: ProcessNode[], flows: ProcessFlow[]): {
    isValid: boolean;
    errors: string[];
  } {
    const errors: string[] = [];

    // 检查必需的开始和结束节点
    const startNodes = nodes.filter(n => n.type === 'start');
    const endNodes = nodes.filter(n => n.type === 'end');

    if (startNodes.length === 0) {
      errors.push('流程必须包含一个开始节点');
    }
    if (startNodes.length > 1) {
      errors.push('流程只能包含一个开始节点');
    }
    if (endNodes.length === 0) {
      errors.push('流程必须包含至少一个结束节点');
    }

    // 检查节点连接
    nodes.forEach(node => {
      if (node.type !== 'end') {
        const outgoingFlows = flows.filter(f => f.from === node.id);
        if (outgoingFlows.length === 0) {
          errors.push(`节点 "${node.name}" 缺少出口连线`);
        }
      }
      if (node.type !== 'start') {
        const incomingFlows = flows.filter(f => f.to === node.id);
        if (incomingFlows.length === 0) {
          errors.push(`节点 "${node.name}" 缺少入口连线`);
        }
      }
    });

    return {
      isValid: errors.length === 0,
      errors
    };
  }
}
```

**16:00-18:00 流程设计器页面集成 (2小时)**

创建 `src/pages/process/ProcessDesign.tsx`:
```tsx
import React, { useState, useCallback } from 'react';
import { Row, Col, Card, Button, Space, message } from 'antd';
import { SaveOutlined, UndoOutlined, RedoOutlined, ClearOutlined } from '@ant-design/icons';
import { Node, Edge } from 'reactflow';

import ProcessDesigner from '../../components/process/ProcessDesigner';
import NodePalette from '../../components/process/NodePalette';
import NodePropertiesPanel from '../../components/process/NodePropertiesPanel';
import { ProcessConverter } from '../../utils/processConverter';

const ProcessDesign: React.FC = () => {
  const [nodes, setNodes] = useState<Node[]>([]);
  const [edges, setEdges] = useState<Edge[]>([]);
  const [selectedNode, setSelectedNode] = useState<Node | null>(null);
  const [processName, setProcessName] = useState('新流程');

  // 添加节点
  const handleAddNode = useCallback((type: string) => {
    const newNode: Node = {
      id: `${type}-${Date.now()}`,
      type,
      position: { x: Math.random() * 400, y: Math.random() * 400 },
      data: { label: `${type === 'start' ? '开始' : type === 'end' ? '结束' : '新任务'}` }
    };
    setNodes(nds => [...nds, newNode]);
  }, [setNodes]);

  // 保存流程
  const handleSave = useCallback(() => {
    const { nodes: processNodes, flows } = ProcessConverter.reactFlowToInternal(nodes, edges);
    const validation = ProcessConverter.validateProcess(processNodes, flows);
    
    if (!validation.isValid) {
      message.error(`流程验证失败: ${validation.errors.join(', ')}`);
      return;
    }

    // 调用API保存
    console.log('Saving process:', { nodes: processNodes, flows });
    message.success('流程保存成功');
  }, [nodes, edges]);

  return (
    <div className="process-design-page">
      <Row gutter={[8, 8]} style={{ height: '100%' }}>
        <Col span={4}>
          <Space direction="vertical" style={{ width: '100%' }}>
            <NodePalette onAddNode={handleAddNode} />
            <NodePropertiesPanel 
              selectedNode={selectedNode}
              onUpdateNode={(nodeId, updates) => {
                setNodes(nds => nds.map(n => 
                  n.id === nodeId ? { ...n, data: { ...n.data, ...updates } } : n
                ));
              }}
              onDeleteNode={(nodeId) => {
                setNodes(nds => nds.filter(n => n.id !== nodeId));
                setEdges(eds => eds.filter(e => e.source !== nodeId && e.target !== nodeId));
                setSelectedNode(null);
              }}
            />
          </Space>
        </Col>
        
        <Col span={20}>
          <Card 
            title={processName}
            size="small"
            extra={
              <Space>
                <Button icon={<UndoOutlined />} size="small">撤销</Button>
                <Button icon={<RedoOutlined />} size="small">重做</Button>
                <Button icon={<ClearOutlined />} size="small">清空</Button>
                <Button 
                  type="primary" 
                  icon={<SaveOutlined />} 
                  size="small"
                  onClick={handleSave}
                >
                  保存
                </Button>
              </Space>
            }
            bodyStyle={{ padding: 0, height: 'calc(100vh - 140px)' }}
          >
            <ProcessDesigner 
              nodes={nodes}
              edges={edges}
              onNodesChange={(changes) => {/* 处理节点变化 */}}
              onEdgesChange={(changes) => {/* 处理连线变化 */}}
              onNodeSelect={setSelectedNode}
            />
          </Card>
        </Col>
      </Row>
    </div>
  );
};

export default ProcessDesign;
```

#### 📝 Day 8 交付清单
- [ ] ReactFlow集成完成
- [ ] 自定义节点组件实现
- [ ] 节点工具栏功能
- [ ] 数据转换工具实现
- [ ] 流程设计器页面集成

---

### Day 9 (Thursday) - 8小时
**主题**: 流程列表页面和API集成

#### 上午 (4小时)
**9:00-11:00 流程列表页面 (2小时)**

创建 `src/pages/process/ProcessList.tsx`:
```tsx
import React, { useState, useEffect } from 'react';
import { 
  Table, 
  Card, 
  Button, 
  Space, 
  Tag, 
  Dropdown, 
  Input, 
  Select,
  Modal,
  message 
} from 'antd';
import { 
  PlusOutlined, 
  EditOutlined, 
  DeleteOutlined, 
  CopyOutlined,
  EyeOutlined,
  SearchOutlined 
} from '@ant-design/icons';
import { useNavigate } from 'react-router-dom';
import { formatRelativeTime } from '../../utils/formatters';

const ProcessList: React.FC = () => {
  const navigate = useNavigate();
  const [processes, setProcesses] = useState([]);
  const [loading, setLoading] = useState(false);
  const [searchText, setSearchText] = useState('');
  const [categoryFilter, setCategoryFilter] = useState('all');

  const columns = [
    {
      title: '流程名称',
      dataIndex: 'name',
      key: 'name',
      render: (name: string, record: any) => (
        <Space>
          <span style={{ fontWeight: 500 }}>{name}</span>
          <Tag color="blue">v{record.version}</Tag>
        </Space>
      ),
    },
    {
      title: '流程标识',
      dataIndex: 'key',
      key: 'key',
      render: (key: string) => <code>{key}</code>,
    },
    {
      title: '分类',
      dataIndex: 'category',
      key: 'category',
      render: (category: string) => category ? <Tag>{category}</Tag> : '-',
    },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      render: (status: string) => {
        const statusConfig = {
          draft: { color: 'orange', text: '草稿' },
          published: { color: 'green', text: '已发布' },
          archived: { color: 'default', text: '已归档' },
        };
        const config = statusConfig[status] || statusConfig.draft;
        return <Tag color={config.color}>{config.text}</Tag>;
      },
    },
    {
      title: '创建时间',
      dataIndex: 'created_at',
      key: 'created_at',
      render: (time: string) => formatRelativeTime(time),
    },
    {
      title: '操作',
      key: 'actions',
      render: (_, record: any) => (
        <Space>
          <Button 
            type="text" 
            icon={<EyeOutlined />} 
            size="small"
            onClick={() => navigate(`/process/${record.id}/view`)}
          >
            查看
          </Button>
          <Button 
            type="text" 
            icon={<EditOutlined />} 
            size="small"
            onClick={() => navigate(`/process/${record.id}/edit`)}
          >
            编辑
          </Button>
          <Dropdown
            menu={{
              items: [
                {
                  key: 'copy',
                  icon: <CopyOutlined />,
                  label: '复制',
                  onClick: () => handleCopyProcess(record.id),
                },
                {
                  key: 'delete',
                  icon: <DeleteOutlined />,
                  label: '删除',
                  danger: true,
                  onClick: () => handleDeleteProcess(record.id),
                },
              ],
            }}
          >
            <Button type="text" size="small">更多</Button>
          </Dropdown>
        </Space>
      ),
    },
  ];

  return (
    <div className="process-list-page">
      <Card 
        title="流程管理"
        extra={
          <Button 
            type="primary" 
            icon={<PlusOutlined />}
            onClick={() => navigate('/process/create')}
          >
            创建流程
          </Button>
        }
      >
        <Space direction="vertical" style={{ width: '100%' }}>
          <Row gutter={[16, 16]}>
            <Col span={8}>
              <Input
                placeholder="搜索流程名称或标识"
                prefix={<SearchOutlined />}
                value={searchText}
                onChange={(e) => setSearchText(e.target.value)}
              />
            </Col>
            <Col span={6}>
              <Select
                placeholder="选择分类"
                style={{ width: '100%' }}
                value={categoryFilter}
                onChange={setCategoryFilter}
              >
                <Select.Option value="all">全部分类</Select.Option>
                <Select.Option value="approval">审批流程</Select.Option>
                <Select.Option value="workflow">工作流程</Select.Option>
              </Select>
            </Col>
          </Row>
          
          <Table
            columns={columns}
            dataSource={processes}
            loading={loading}
            rowKey="id"
            pagination={{
              pageSize: 20,
              showSizeChanger: true,
              showQuickJumper: true,
              showTotal: (total) => `共 ${total} 条记录`,
            }}
          />
        </Space>
      </Card>
    </div>
  );
};

export default ProcessList;
```

**11:00-13:00 流程API服务 (2小时)**

创建 `src/services/processApi.ts`:
```typescript
import { http } from '../utils/http';
import { ProcessDefinition, CreateProcessRequest, UpdateProcessRequest } from '../types/process';
import { PaginationParams } from '../types/api';

export const processApi = {
  // 创建流程
  async createProcess(data: CreateProcessRequest): Promise<ProcessDefinition> {
    const response = await http.post<ProcessDefinition>('/process', data);
    if ('error' in response.data) {
      throw new Error(response.data.error);
    }
    return response.data.data!;
  },

  // 获取流程列表
  async getProcesses(params?: PaginationParams & {
    search?: string;
    category?: string;
    status?: string;
  }): Promise<{
    processes: ProcessDefinition[];
    total: number;
    page: number;
    page_size: number;
  }> {
    const queryParams = new URLSearchParams();
    if (params?.page) queryParams.append('page', params.page.toString());
    if (params?.page_size) queryParams.append('page_size', params.page_size.toString());
    if (params?.search) queryParams.append('search', params.search);
    if (params?.category) queryParams.append('category', params.category);
    if (params?.status) queryParams.append('status', params.status);
    
    const url = `/process${queryParams.toString() ? `?${queryParams.toString()}` : ''}`;
    const response = await http.get(url);
    if ('error' in response.data) {
      throw new Error(response.data.error);
    }
    return response.data.data!;
  },

  // 获取流程详情
  async getProcess(id: number): Promise<ProcessDefinition> {
    const response = await http.get<ProcessDefinition>(`/process/${id}`);
    if ('error' in response.data) {
      throw new Error(response.data.error);
    }
    return response.data.data!;
  },

  // 更新流程
  async updateProcess(id: number, data: UpdateProcessRequest): Promise<ProcessDefinition> {
    const response = await http.put<ProcessDefinition>(`/process/${id}`, data);
    if ('error' in response.data) {
      throw new Error(response.data.error);
    }
    return response.data.data!;
  },

  // 删除流程
  async deleteProcess(id: number): Promise<void> {
    const response = await http.delete(`/process/${id}`);
    if ('error' in response.data) {
      throw new Error(response.data.error);
    }
  },

  // 复制流程
  async copyProcess(id: number): Promise<ProcessDefinition> {
    const response = await http.post<ProcessDefinition>(`/process/${id}/copy`);
    if ('error' in response.data) {
      throw new Error(response.data.error);
    }
    return response.data.data!;
  },
};
```

#### 📝 Day 9 交付清单
- [ ] 流程列表页面完成
- [ ] 流程API服务实现
- [ ] 搜索和筛选功能
- [ ] 流程操作功能(查看、编辑、删除、复制)

---

### Day 10 (Friday) - 8小时
**主题**: 流程创建编辑页面和完整集成

#### 上午 (4小时)
**9:00-11:00 流程创建/编辑页面 (2小时)**

创建 `src/pages/process/ProcessEdit.tsx`:
```tsx
import React, { useState, useEffect } from 'react';
import { Form, Input, Select, Button, Space, Card, Row, Col, message } from 'antd';
import { SaveOutlined, ArrowLeftOutlined } from '@ant-design/icons';
import { useNavigate, useParams } from 'react-router-dom';
import ProcessDesigner from '../../components/process/ProcessDesigner';
import { processApi } from '../../services/processApi';

const ProcessEdit: React.FC = () => {
  const navigate = useNavigate();
  const { id } = useParams<{ id: string }>();
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [processData, setProcessData] = useState(null);

  // 加载流程数据
  useEffect(() => {
    if (id && id !== 'create') {
      loadProcess(parseInt(id));
    }
  }, [id]);

  const loadProcess = async (processId: number) => {
    setLoading(true);
    try {
      const process = await processApi.getProcess(processId);
      setProcessData(process);
      form.setFieldsValue({
        name: process.name,
        key: process.key,
        description: process.description,
        category: process.category,
      });
    } catch (error) {
      message.error('加载流程失败');
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async (values: any) => {
    setSaving(true);
    try {
      if (id === 'create') {
        await processApi.createProcess(values);
        message.success('流程创建成功');
      } else {
        await processApi.updateProcess(parseInt(id!), values);
        message.success('流程更新成功');
      }
      navigate('/process');
    } catch (error) {
      message.error('保存失败');
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="process-edit-page">
      <Card 
        title={
          <Space>
            <Button 
              type="text" 
              icon={<ArrowLeftOutlined />}
              onClick={() => navigate('/process')}
            >
              返回列表
            </Button>
            <span>{id === 'create' ? '创建流程' : '编辑流程'}</span>
          </Space>
        }
        extra={
          <Button 
            type="primary" 
            icon={<SaveOutlined />}
            loading={saving}
            onClick={() => form.submit()}
          >
            保存流程
          </Button>
        }
      >
        <Row gutter={[16, 16]}>
          <Col span={8}>
            <Card title="基本信息" size="small">
              <Form
                form={form}
                layout="vertical"
                onFinish={handleSave}
              >
                <Form.Item
                  name="key"
                  label="流程标识"
                  rules={[
                    { required: true, message: '请输入流程标识' },
                    { pattern: /^[a-zA-Z0-9_]+$/, message: '只能包含字母、数字和下划线' }
                  ]}
                >
                  <Input placeholder="process_key" disabled={id !== 'create'} />
                </Form.Item>
                
                <Form.Item
                  name="name"
                  label="流程名称"
                  rules={[{ required: true, message: '请输入流程名称' }]}
                >
                  <Input placeholder="请输入流程名称" />
                </Form.Item>
                
                <Form.Item name="category" label="流程分类">
                  <Select placeholder="选择分类">
                    <Select.Option value="approval">审批流程</Select.Option>
                    <Select.Option value="workflow">工作流程</Select.Option>
                    <Select.Option value="other">其他</Select.Option>
                  </Select>
                </Form.Item>
                
                <Form.Item name="description" label="流程描述">
                  <Input.TextArea 
                    placeholder="描述流程的用途和特点"
                    rows={4}
                  />
                </Form.Item>
              </Form>
            </Card>
          </Col>
          
          <Col span={16}>
            <Card title="流程设计" size="small">
              <ProcessDesigner />
            </Card>
          </Col>
        </Row>
      </Card>
    </div>
  );
};

export default ProcessEdit;
```

**11:00-13:00 Wire依赖注入更新 (2小时)**

更新 `internal/wire/wire.go`:
```go
// 添加Process相关的Provider
var ProviderSet = wire.NewSet(
    // 现有的Provider...
    
    // Process providers
    repository.NewProcessRepository,
    service.NewProcessService,
    
    // 更新Server provider
    server.NewServer,
)
```

更新 `internal/server/server.go`:
```go
func NewServer(
    cfg *config.Config,
    db *database.Database,
    log *logger.Logger,
    userService *service.UserService,
    processService *service.ProcessService, // 新增
    jwtManager *utils.JWTManager,
) *Server {
    // ...现有代码
    
    // 创建router时传入processService
    router := handler.NewRouter(userService, processService, jwtManager, log)
    
    // ...
}
```

#### 下午 (4小时)
**14:00-16:00 路由配置更新 (2小时)**

更新 `internal/handler/router.go`:
```go
func NewRouter(
    userService *service.UserService,
    processService *service.ProcessService, // 新增
    jwtManager *utils.JWTManager,
    logger *logger.Logger,
) *Router {
    userHandler := NewUserHandler(userService, logger)
    processHandler := NewProcessHandler(processService, logger) // 新增
    authMiddleware := middleware.NewAuthMiddleware(jwtManager, logger)

    return &Router{
        userHandler:    userHandler,
        processHandler: processHandler, // 新增
        authMiddleware: authMiddleware,
        logger:         logger,
    }
}

func (r *Router) SetupRoutes(e *echo.Echo) {
    // ...现有路由
    
    // Process routes (需要认证)
    process := api.Group("/process")
    process.Use(r.authMiddleware.JWTAuth())
    {
        process.GET("", r.processHandler.GetProcesses)
        process.POST("", r.processHandler.CreateProcess)
        process.GET("/:id", r.processHandler.GetProcess)
        process.PUT("/:id", r.processHandler.UpdateProcess)
        process.DELETE("/:id", r.processHandler.DeleteProcess)
        process.POST("/:id/copy", r.processHandler.CopyProcess)
        process.GET("/:id/versions", r.processHandler.GetProcessVersions)
    }
}
```

更新前端路由 `src/App.tsx`:
```tsx
// 在ProtectedRoute内添加流程相关路由
<Route path="process" element={<ProcessList />} />
<Route path="process/create" element={<ProcessEdit />} />
<Route path="process/:id/edit" element={<ProcessEdit />} />
<Route path="process/:id/view" element={<ProcessDesigner />} />
```

**16:00-18:00 集成测试和调试 (2小时)**

创建测试脚本 `scripts/test_process_api.py`:
```python
#!/usr/bin/env python3
import requests
import json

BASE_URL = "http://localhost:8080/api/v1"

def test_process_apis():
    # 登录获取token
    login_response = requests.post(f"{BASE_URL}/auth/login", json={
        "username": "testuser",
        "password": "password123"
    })
    
    token = login_response.json()["data"]["token"]
    headers = {"Authorization": f"Bearer {token}"}
    
    # 测试创建流程
    create_data = {
        "key": "test_process",
        "name": "测试流程",
        "description": "这是一个测试流程",
        "category": "approval",
        "definition": {
            "nodes": [
                {
                    "id": "start1",
                    "type": "start",
                    "name": "开始",
                    "x": 100,
                    "y": 100
                },
                {
                    "id": "task1", 
                    "type": "userTask",
                    "name": "审核任务",
                    "x": 300,
                    "y": 100,
                    "props": {"assignee": "admin"}
                },
                {
                    "id": "end1",
                    "type": "end", 
                    "name": "结束",
                    "x": 500,
                    "y": 100
                }
            ],
            "flows": [
                {
                    "id": "flow1",
                    "from": "start1",
                    "to": "task1"
                },
                {
                    "id": "flow2", 
                    "from": "task1",
                    "to": "end1"
                }
            ]
        }
    }
    
    # 执行测试
    print("🧪 测试流程API...")
    
    # 创建流程
    create_response = requests.post(f"{BASE_URL}/process", 
                                   json=create_data, headers=headers)
    print(f"创建流程: {create_response.status_code}")
    
    if create_response.status_code == 201:
        process_id = create_response.json()["data"]["id"]
        
        # 获取流程列表
        list_response = requests.get(f"{BASE_URL}/process", headers=headers)
        print(f"获取流程列表: {list_response.status_code}")
        
        # 获取流程详情
        detail_response = requests.get(f"{BASE_URL}/process/{process_id}", headers=headers)
        print(f"获取流程详情: {detail_response.status_code}")
        
        # 更新流程
        update_data = create_data.copy()
        update_data["name"] = "更新后的测试流程"
        update_response = requests.put(f"{BASE_URL}/process/{process_id}", 
                                     json=update_data, headers=headers)
        print(f"更新流程: {update_response.status_code}")

if __name__ == "__main__":
    test_process_apis()
```

#### 📝 Day 10 交付清单
- [ ] 流程创建/编辑页面完成
- [ ] 流程API服务实现
- [ ] Wire依赖注入更新
- [ ] 路由配置完成
- [ ] 流程API测试脚本

---

## 📊 第2周总结

### ✅ 完成的功能
1. **流程数据模型** - 完整的GORM模型设计
2. **ReactFlow集成** - 可视化流程建模器
3. **流程管理界面** - 列表、创建、编辑页面
4. **API接口** - 完整的流程CRUD操作
5. **数据转换** - ReactFlow与内部格式转换

### 📊 代码统计预估
- **后端代码**: ~800行 (模型、服务、API)
- **前端代码**: ~1200行 (组件、页面、工具)
- **测试代码**: ~200行 (API测试)
- **总计**: ~2200行代码

### 🧪 测试验证
- [ ] 流程创建和保存功能
- [ ] 可视化建模器操作
- [ ] 流程列表和管理功能
- [ ] 前后端API集成
- [ ] 数据格式转换正确性

### 📝 下周准备
- 流程执行引擎开发
- 任务管理系统
- 流程实例和状态管理
- 用户任务分配和处理

---

**开发者**: [姓名]  
**完成时间**: 第2周 Friday 18:00  
**下周计划**: 流程执行引擎和任务管理系统开发
